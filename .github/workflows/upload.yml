name: "Upload"

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '18 13 * * 6'

jobs:
    build:
        name: Build the CSV
        runs-on: ubuntu-latest
        permissions:
            actions: write
            contents: write
            security-events: write

        steps:
            - uses: actions/checkout@v2
              with:
                persist-credentials: false 
                fetch-depth: 0
            - run: |
                pip3 install -r requirements.txt
                python3 main.py

            - uses: actions/upload-artifact@v3
              with:
                name: csv-build
                path: csv-dump.csv

    release:
        needs:
          - build
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v3
                with:
                    fetch-depth: 0 
            -   name: Declare github short hash.
                id: vars
                shell: bash
                run: |
                    echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
            -   name: Download artifacts
                uses: actions/download-artifact@v2
                with:
                    path: .
            -   name: Create GitHub release
                id: create_release
                uses: actions/create-release@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    tag_name: ${{ steps.vars.outputs.sha_short }}
                    release_name: csvbuild ${{ steps.vars.outputs.sha_short }}
                    draft: false
                    prerelease: false
            -   name: Upload Asset.
                uses: actions/upload-release-asset@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    upload_url: ${{ steps.create_release.outputs.upload_url }}
                    asset_path: csv-build/csv-dump.csv
                    asset_name: csv-${{ steps.vars.outputs.sha_short }}.csv
                    asset_content_type: text/csv
        